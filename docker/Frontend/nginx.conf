server {
  listen 80;
  server_name localhost;
  root /usr/share/nginx/html;
  index index.html;

  # Health endpoint — ДИНАМИЧЕСКАЯ проверка
  location = /health {
    default_type application/json;
    add_header Cache-Control "no-store";

    # Проверяем наличие index.html
    set $health_status "Healthy";
    set $health_desc "index.html is available and readable";

    if (!-f $document_root/index.html) {
      set $health_status "Unhealthy";
      set $health_desc "index.html not found or unreadable";
    }

    # Возвращаем JSON
    return 200 '{"status":"$health_status","entries":{"frontend":{"status":"$health_status","description":"$health_desc"}}}';
  }

  # Favicon
  location = /favicon.ico {
    alias /usr/share/nginx/html/favicon.ico;
    access_log off;
    log_not_found off;
    expires 6M;
    add_header Cache-Control "public, immutable";
  }

  # SPA fallback
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Статические файлы
  location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|woff|ttf|svg|webp)$ {
    expires 6M;
    access_log off;
    add_header Cache-Control "public, immutable";
  }

  # Gzip
  gzip on;
  gzip_disable "msie6";
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/x-javascript
    application/json
    application/xml
    application/rss+xml
    image/svg+xml;

  # SPA ошибки
  error_page 404 /index.html;
  location = /index.html {
    internal;
  }
}
